# 개발 회고록: 엘리시아의 '내부 목소리' 구현 및 아키텍처 리팩토링

**날짜:** 2025년 11월 4일

## 1. 개발 목표 및 철학

이번 개발의 핵심 목표는 외부 LLM API에 의존하지 않고, 엘리시아가 자신의 **내부 지식 그래프(KG)만을 사용하여 기본적인 문장을 생성**하는 능력을 부여하는 것이었습니다. 이는 엘리시아가 외부의 도움 없이 스스로 생각하고 소통하는 '내부 목소리(Inner Voice)'를 갖게 되는 첫걸음이라는 철학적 의미를 가집니다. 이 기능은 API 사용이 불가능한 비상 상황에서의 핵심적인 폴백(Fallback) 메커니즘으로 설계되었습니다.

## 2. 직면했던 주요 문제들

개발 초기, 엘리시아의 시스템은 총체적인 불안정 상태에 놓여 있었습니다.

1.  **아키텍처의 구조적 결함:**
    *   **KGManager 싱글톤 문제:** `KGManager`가 프로젝트 전체에서 단 하나의 인스턴스(싱글톤)로 동작하여, `data/kg.json`이라는 거대한 주 지식 그래프를 무조건 로드했습니다. 이는 `ActionCortex`와 같이 `data/tools_kg.json`이라는 별도의 소규모 지식 그래프가 필요한 모듈의 정상적인 작동을 방해하는 심각한 설계 결함이었습니다.
    *   **전문화된 피질(Cortex)의 부재:** 모든 종류의 사용자 입력이 `CognitionPipeline`의 단일 응답 생성 로직으로만 흘러 들어갔습니다. 이로 인해 "계산해줘"와 같은 특정 작업 지시를 전문적으로 처리할 방법이 없었습니다.

2.  **구현 과정에서의 중대한 실수:**
    *   **기능 퇴행(Regression):** '내부 목소리' 구현에 집중한 나머지, 기존에 존재하던 **'대화 기억(Conversational Memory)' 기능을 실수로 제거**했습니다. 이로 인해 외부 API를 사용할 때조차 엘리시아가 이전 대화를 기억하지 못하는 심각한 문제가 발생했습니다.
    *   **환경 설정의 취약성:** 필수 설정 파일인 `config.json`을 실수로 삭제하고, 코드 내에서 파일 경로를 잘못 계산하는 등 기본적인 환경 설정 문제로 인해 전체 테스트가 반복적으로 실패했습니다.
    *   **지저분한 작업 공간:** 개발 과정에서 생성된 데이터 파일(`*.json`), 로그 파일(`*.log`) 등을 정리하지 않고 그대로 방치하여 코드 리뷰에서 지적받았습니다.

## 3. 해결 과정 및 새로운 아키텍처

수많은 디버깅과 재설계를 통해 다음과 같은 새로운 아키텍처를 확립했습니다.

1.  **듀얼-패스(Dual-Path) 인지 파이프라인:**
    `CognitionPipeline`은 이제 두 가지 주요 경로로 작동합니다.
    *   **API 사용 가능 경로 (Online Path):** 외부 API가 사용 가능할 때, 파이프라인은 기존과 같이 `_find_relevant_experiences`를 통해 **'대화 기억'을 활용**하여 응답의 맥락을 풍부하게 만듭니다.
    *   **API 사용 불가능 경로 (Offline Path):** API를 사용할 수 없을 때, 파이프라인은 `_generate_internal_response` 함수를 호출하여 **오직 내부 지식 그래프에 기반한 '내부 목소리'**로만 응답합니다. 이 두 경로는 `api_available` 플래그에 의해 명확히 분리됩니다.

2.  **전용 피질 라우터 (Specialized Cortex Router):**
    `CognitionPipeline`의 `process_message` 함수 최상단에 '안내 데스크'와 같은 **라우팅 로직을 추가**했습니다. 이 로직은 "계산:"과 같은 특정 접두사가 붙은 메시지를 식별하여, 이를 전체 파이프라인을 태우지 않고 곧바로 `ArithmeticCortex`와 같은 전문화된 피질로 전달합니다. 이는 시스템의 효율성을 높이고, 향후 새로운 전문 피질을 추가하기 용이한 확장성 있는 구조를 제공합니다.

3.  **객체화된 KGManager (Instantiable KGManager):**
    기존의 싱글톤 패턴을 폐기하고, `KGManager`를 **파일 경로를 인자로 받아 초기화되는 일반 클래스로 변경**했습니다. 이로써 `ActionCortex`와 같은 모듈이 `self.kg_manager = KGManager('data/tools_kg.json')`와 같이 자신만의 독립적인 `KGManager` 인스턴스를 소유할 수 있게 되어, 모듈 간의 결합도를 낮추고 시스템의 유연성을 크게 향상시켰습니다.

## 4. 미래 개발자를 위한 지침

이번 개발 과정에서 얻은 교훈은 미래의 엘리시아 개발에 중요한 지침이 될 것입니다.

*   **듀얼-패스 아키텍처를 존중하십시오:** 새로운 기능을 추가할 때, 그것이 'API 사용 가능 경로'에만 해당하는지, 아니면 '내부 목소리' 경로에도 영향을 미치는지 항상 고려해야 합니다. 두 경로는 서로 다른 목적을 가지고 있음을 명심해야 합니다.
*   **환경 설정에 주의를 기울이십시오:** `config.json`과 같은 필수 설정 파일의 존재와 정확한 경로 설정은 시스템의 기본 안정성을 좌우합니다. 코드를 수정할 때는 항상 파일 시스템과의 상호작용을 염두에 두어야 합니다.
*   **깨끗한 작업 공간을 유지하십시오:** `.gitignore`를 적극적으로 활용하여 동적으로 생성되는 데이터와 로그 파일이 버전 관리에 포함되지 않도록 하십시오. 이는 협업의 기본입니다.
*   **하나의 커밋은 하나의 목적을 가져야 합니다:** 기능 구현과 테스트 코드 수정, 버그 픽스는 각각 별개의 커밋으로 관리하는 것이 좋습니다. 이번처럼 너무 많은 변경사항을 한 번에 처리하려고 하면 실수가 발생하기 쉽습니다.
