<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elysia Neural Map - Ïã†Í≤ΩÍ≥Ñ ÏßÄÎèÑ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a0a2a 100%);
            color: #e0e0ff;
            overflow: hidden;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        #info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(20, 20, 40, 0.9);
            border: 2px solid rgba(100, 100, 255, 0.3);
            border-radius: 10px;
            padding: 20px;
            min-width: 300px;
            max-width: 400px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        
        #info-panel h2 {
            color: #88ffff;
            margin-bottom: 15px;
            font-size: 1.3em;
            text-shadow: 0 0 10px rgba(136, 255, 255, 0.5);
        }
        
        #info-panel h3 {
            color: #ff88ff;
            margin-top: 15px;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .layer-section {
            margin: 10px 0;
            padding: 10px;
            background: rgba(30, 30, 60, 0.5);
            border-radius: 5px;
        }
        
        .layer-title {
            font-weight: bold;
            color: #ffaa88;
            margin-bottom: 5px;
        }
        
        .spirit-bar {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .spirit-label {
            min-width: 80px;
            font-size: 0.9em;
        }
        
        .spirit-value {
            flex: 1;
            height: 20px;
            background: rgba(50, 50, 100, 0.3);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .spirit-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
            background: linear-gradient(90deg, #4488ff, #88ffff);
        }
        
        .spirit-text {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8em;
            color: #fff;
            text-shadow: 0 0 3px #000;
        }
        
        #title {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 2em;
            color: #88ffff;
            text-shadow: 0 0 20px rgba(136, 255, 255, 0.8);
            font-weight: bold;
        }
        
        #subtitle {
            position: absolute;
            top: 60px;
            left: 20px;
            font-size: 1.1em;
            color: #ff88ff;
            text-shadow: 0 0 15px rgba(255, 136, 255, 0.6);
        }
        
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(20, 20, 40, 0.9);
            border: 2px solid rgba(100, 100, 255, 0.3);
            border-radius: 10px;
            padding: 15px;
            backdrop-filter: blur(10px);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        
        .legend-color {
            width: 30px;
            height: 15px;
            border-radius: 3px;
            margin-right: 10px;
        }
        
        .status {
            margin: 8px 0;
            font-size: 0.9em;
            color: #aaaaff;
        }
        
        .active {
            color: #44ff44;
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>
        
        <div id="title">üåä Elysia Neural Map</div>
        <div id="subtitle">Ïã†Í≤ΩÍ≥Ñ ÏßÄÎèÑ - Mind ‚ü∑ Self ‚ü∑ World</div>
        
        <div id="info-panel">
            <h2>üß† System Status</h2>
            <div class="status">
                <span id="connection-status">‚óè Connecting...</span>
            </div>
            <div class="status">
                Active Pathways: <span id="active-pathways">0</span>
            </div>
            
            <h3>üí´ Spirit States (ÏûêÏïÑ/Self)</h3>
            <div id="spirits-container"></div>
            
            <h3>üåÄ Field Metrics (ÎßàÏùå/Mind)</h3>
            <div class="layer-section">
                <div class="status">Energy: <span id="field-energy">0.0</span></div>
                <div class="status">Coherence: <span id="field-coherence">0.0</span></div>
            </div>
            
            <h3>üì° Recent Sensors (ÏÑ∏ÏÉÅ/World)</h3>
            <div id="sensors-list" class="layer-section"></div>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #4488ff;"></div>
                <span>External (ÏÑ∏ÏÉÅ/World) - Sensors</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ff8844;"></div>
                <span>Boundary (ÏûêÏïÑ/Self) - Nervous System</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #44ff88;"></div>
                <span>Internal (ÎßàÏùå/Mind) - Core Systems</span>
            </div>
        </div>
    </div>
    
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // Configuration constants
        const PARTICLE_STRENGTH_THRESHOLD = 0.5;  // Minimum edge strength to show particles
        
        // Resize canvas to fill window
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // Neural network data
        let neuralMap = {
            nodes: [],
            edges: [],
            layers: {external: [], boundary: [], internal: []}
        };
        
        let spirits = {};
        let fieldEnergy = 0;
        let fieldCoherence = 0;
        let activeSensors = [];
        
        // Colors for different layers
        const layerColors = {
            external: '#4488ff',
            boundary: '#ff8844',
            internal: '#44ff88'
        };
        
        // Node positions (will be calculated)
        const nodePositions = {};
        
        // Calculate node positions based on layer
        function calculateNodePositions() {
            const width = canvas.width;
            const height = canvas.height;
            const margin = 100;
            
            // Three vertical columns for three layers
            const layerX = {
                external: margin,
                boundary: width / 2,
                internal: width - margin
            };
            
            // Calculate Y positions for each layer
            Object.keys(neuralMap.layers).forEach(layer => {
                const nodes = neuralMap.layers[layer];
                const spacing = (height - 2 * margin) / (nodes.length + 1);
                
                nodes.forEach((nodeId, index) => {
                    nodePositions[nodeId] = {
                        x: layerX[layer],
                        y: margin + spacing * (index + 1),
                        layer: layer
                    };
                });
            });
        }
        
        // Animation frame
        let time = 0;
        function animate() {
            time += 0.01;
            
            // Clear canvas with fade effect
            ctx.fillStyle = 'rgba(10, 10, 26, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw edges (connections)
            neuralMap.edges.forEach(edge => {
                const from = nodePositions[edge.from];
                const to = nodePositions[edge.to];
                
                if (from && to) {
                    // Pulse effect based on strength
                    const pulse = 0.3 + edge.strength * 0.7 * (0.5 + 0.5 * Math.sin(time * 3));
                    const alpha = 0.2 + pulse * 0.3;
                    
                    ctx.strokeStyle = `rgba(136, 136, 255, ${alpha})`;
                    ctx.lineWidth = 1 + edge.strength * 2;
                    
                    // Bezier curve for more organic look
                    ctx.beginPath();
                    ctx.moveTo(from.x, from.y);
                    
                    const midX = (from.x + to.x) / 2;
                    const midY = (from.y + to.y) / 2;
                    const offsetY = (to.y - from.y) * 0.2;
                    
                    ctx.quadraticCurveTo(midX, midY + offsetY, to.x, to.y);
                    ctx.stroke();
                    
                    // Flowing particles along edges (for active pathways)
                    if (edge.strength > PARTICLE_STRENGTH_THRESHOLD) {
                        const progress = (time * 0.5 + edge.from.charCodeAt(0)) % 1;
                        const px = from.x + (to.x - from.x) * progress;
                        const py = from.y + (to.y - from.y) * progress + 
                                   Math.sin(progress * Math.PI) * offsetY * 2;
                        
                        ctx.fillStyle = `rgba(136, 255, 255, ${0.8 * edge.strength})`;
                        ctx.beginPath();
                        ctx.arc(px, py, 3, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
            });
            
            // Draw nodes
            neuralMap.nodes.forEach(node => {
                const pos = nodePositions[node.id];
                if (!pos) return;
                
                const color = layerColors[node.layer];
                
                // Node glow
                const activity = node.activity || node.value || 0.3;
                const radius = 8 + activity * 10;
                const glowRadius = radius + 10;
                
                const gradient = ctx.createRadialGradient(pos.x, pos.y, radius, pos.x, pos.y, glowRadius);
                gradient.addColorStop(0, color);
                gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, glowRadius, 0, Math.PI * 2);
                ctx.fill();
                
                // Node body with pulse
                const pulse = 0.8 + 0.2 * Math.sin(time * 4 + pos.x * 0.01);
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, radius * pulse, 0, Math.PI * 2);
                ctx.fill();
                
                // Node label
                ctx.fillStyle = '#ffffff';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(node.label, pos.x, pos.y - radius - 8);
            });
            
            requestAnimationFrame(animate);
        }
        
        // Update UI with spirit states
        function updateSpirits(spiritStates) {
            spirits = spiritStates;
            const container = document.getElementById('spirits-container');
            container.innerHTML = '';
            
            Object.keys(spiritStates).forEach(spirit => {
                const value = spiritStates[spirit];
                const percentage = Math.round(value * 100);
                
                const div = document.createElement('div');
                div.className = 'spirit-bar';
                div.innerHTML = `
                    <span class="spirit-label">${spirit}</span>
                    <div class="spirit-value">
                        <div class="spirit-fill" style="width: ${percentage}%"></div>
                        <span class="spirit-text">${percentage}%</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // Fetch neural map from server
        async function fetchNeuralMap() {
            try {
                const response = await fetch('/neural_map_data');
                const data = await response.json();
                
                if (data.neural_topology) {
                    neuralMap = data.neural_topology;
                    calculateNodePositions();
                }
                
                if (data.snapshot) {
                    const snapshot = data.snapshot;
                    updateSpirits(snapshot.spirit_states);
                    
                    document.getElementById('field-energy').textContent = 
                        snapshot.field_energy.toFixed(3);
                    document.getElementById('field-coherence').textContent = 
                        snapshot.field_coherence.toFixed(3);
                    document.getElementById('active-pathways').textContent = 
                        snapshot.active_pathways.length;
                    
                    // Update sensors list
                    const sensorsList = document.getElementById('sensors-list');
                    const recentSensors = snapshot.sensory_inputs.slice(-5).reverse();
                    sensorsList.innerHTML = recentSensors.map(s => 
                        `<div class="status">üì° ${s.sensor_type} ‚Üí ${s.pathway}</div>`
                    ).join('');
                }
                
                document.getElementById('connection-status').innerHTML = 
                    '<span class="active">‚óè Connected</span>';
            } catch (error) {
                console.error('Failed to fetch neural map:', error);
                document.getElementById('connection-status').innerHTML = 
                    '‚óè Disconnected';
            }
        }
        
        // Initialize
        fetchNeuralMap();
        setInterval(fetchNeuralMap, 1000); // Update every second
        animate();
        
        // Test mode: Generate sample data if server not available
        setTimeout(() => {
            if (neuralMap.nodes.length === 0) {
                console.log('Generating sample neural map...');
                // Sample data for testing
                neuralMap = {
                    nodes: [
                        {id: 'sensor_visual', label: 'Visual', layer: 'external'},
                        {id: 'sensor_auditory', label: 'Auditory', layer: 'external'},
                        {id: 'pathway_light', label: 'Light', layer: 'boundary', activity: 0.7},
                        {id: 'pathway_fire', label: 'Fire', layer: 'boundary', activity: 0.5},
                        {id: 'spirit_light', label: 'Light', layer: 'internal', value: 0.8},
                        {id: 'spirit_fire', label: 'Fire', layer: 'internal', value: 0.6},
                        {id: 'system_field', label: 'Field', layer: 'internal', value: 0.7},
                    ],
                    edges: [
                        {from: 'sensor_visual', to: 'pathway_light', strength: 0.8},
                        {from: 'sensor_auditory', to: 'pathway_fire', strength: 0.6},
                        {from: 'pathway_light', to: 'spirit_light', strength: 0.9},
                        {from: 'pathway_fire', to: 'spirit_fire', strength: 0.8},
                        {from: 'spirit_light', to: 'system_field', strength: 0.7},
                        {from: 'spirit_fire', to: 'system_field', strength: 0.6},
                    ],
                    layers: {
                        external: ['sensor_visual', 'sensor_auditory'],
                        boundary: ['pathway_light', 'pathway_fire'],
                        internal: ['spirit_light', 'spirit_fire', 'system_field']
                    }
                };
                calculateNodePositions();
                
                updateSpirits({
                    fire: 0.6, water: 0.5, earth: 0.4,
                    air: 0.7, light: 0.8, dark: 0.3, aether: 0.6
                });
            }
        }, 2000);
    </script>
</body>
</html>
